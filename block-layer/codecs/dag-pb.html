<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DAG-PB Spec | IPLD Specifications</title>
    <meta name="generator" content="VuePress 1.7.0">
    
    <meta name="description" content="Specifications for the Inter-planetary Linked Data project">
    
    <link rel="preload" href="/assets/css/0.styles.ffa631a0.css" as="style"><link rel="preload" href="/assets/js/app.529fa14a.js" as="script"><link rel="preload" href="/assets/js/2.78e42933.js" as="script"><link rel="preload" href="/assets/js/18.210763d5.js" as="script"><link rel="prefetch" href="/assets/js/10.4073b5e0.js"><link rel="prefetch" href="/assets/js/11.d04c5ee0.js"><link rel="prefetch" href="/assets/js/12.4ff59092.js"><link rel="prefetch" href="/assets/js/13.4197fa40.js"><link rel="prefetch" href="/assets/js/14.5050e84a.js"><link rel="prefetch" href="/assets/js/15.c6727780.js"><link rel="prefetch" href="/assets/js/16.4767d10f.js"><link rel="prefetch" href="/assets/js/17.ce8ad5b3.js"><link rel="prefetch" href="/assets/js/19.0799e055.js"><link rel="prefetch" href="/assets/js/20.17e0228d.js"><link rel="prefetch" href="/assets/js/21.5bb2461f.js"><link rel="prefetch" href="/assets/js/22.ef34f37a.js"><link rel="prefetch" href="/assets/js/23.816d6c53.js"><link rel="prefetch" href="/assets/js/24.02af1729.js"><link rel="prefetch" href="/assets/js/25.b9e0883e.js"><link rel="prefetch" href="/assets/js/26.111b9423.js"><link rel="prefetch" href="/assets/js/27.7337c026.js"><link rel="prefetch" href="/assets/js/28.6c5030d5.js"><link rel="prefetch" href="/assets/js/29.2da56da6.js"><link rel="prefetch" href="/assets/js/3.db7c5fbd.js"><link rel="prefetch" href="/assets/js/30.4135a8ee.js"><link rel="prefetch" href="/assets/js/31.30991936.js"><link rel="prefetch" href="/assets/js/32.f14156a2.js"><link rel="prefetch" href="/assets/js/33.acb4e301.js"><link rel="prefetch" href="/assets/js/34.2241417c.js"><link rel="prefetch" href="/assets/js/35.36f77f2f.js"><link rel="prefetch" href="/assets/js/36.fcfca009.js"><link rel="prefetch" href="/assets/js/37.1db6d712.js"><link rel="prefetch" href="/assets/js/38.3950fc7e.js"><link rel="prefetch" href="/assets/js/39.e97b7c1e.js"><link rel="prefetch" href="/assets/js/4.f53df76f.js"><link rel="prefetch" href="/assets/js/40.6107c72d.js"><link rel="prefetch" href="/assets/js/41.9a2bbe8e.js"><link rel="prefetch" href="/assets/js/42.70713c3a.js"><link rel="prefetch" href="/assets/js/43.01b63e60.js"><link rel="prefetch" href="/assets/js/44.d8b25471.js"><link rel="prefetch" href="/assets/js/45.ccb92ae0.js"><link rel="prefetch" href="/assets/js/46.4cde9a2c.js"><link rel="prefetch" href="/assets/js/47.70b01404.js"><link rel="prefetch" href="/assets/js/48.38a96a44.js"><link rel="prefetch" href="/assets/js/49.f10134b5.js"><link rel="prefetch" href="/assets/js/5.ecba2b37.js"><link rel="prefetch" href="/assets/js/50.0569fd66.js"><link rel="prefetch" href="/assets/js/51.ea27ac5c.js"><link rel="prefetch" href="/assets/js/52.d4a7b4a1.js"><link rel="prefetch" href="/assets/js/53.ead3ee9d.js"><link rel="prefetch" href="/assets/js/54.7d824f6b.js"><link rel="prefetch" href="/assets/js/55.b58f5a47.js"><link rel="prefetch" href="/assets/js/56.12478f9c.js"><link rel="prefetch" href="/assets/js/57.5a5f3781.js"><link rel="prefetch" href="/assets/js/58.dc5a315d.js"><link rel="prefetch" href="/assets/js/59.495a32a6.js"><link rel="prefetch" href="/assets/js/6.43c100a8.js"><link rel="prefetch" href="/assets/js/60.6ee3fc7a.js"><link rel="prefetch" href="/assets/js/61.22341aa9.js"><link rel="prefetch" href="/assets/js/62.56b0b4fd.js"><link rel="prefetch" href="/assets/js/63.dbd3889b.js"><link rel="prefetch" href="/assets/js/64.605b8e96.js"><link rel="prefetch" href="/assets/js/65.7587f893.js"><link rel="prefetch" href="/assets/js/66.58c087ec.js"><link rel="prefetch" href="/assets/js/67.b4fee06d.js"><link rel="prefetch" href="/assets/js/68.ba56fc44.js"><link rel="prefetch" href="/assets/js/69.850e3ede.js"><link rel="prefetch" href="/assets/js/7.5a495ecf.js"><link rel="prefetch" href="/assets/js/70.656638b4.js"><link rel="prefetch" href="/assets/js/71.bac78ded.js"><link rel="prefetch" href="/assets/js/72.31a93e8c.js"><link rel="prefetch" href="/assets/js/73.24b0f915.js"><link rel="prefetch" href="/assets/js/74.8d0145fd.js"><link rel="prefetch" href="/assets/js/75.b9a9dbd6.js"><link rel="prefetch" href="/assets/js/76.67193a3c.js"><link rel="prefetch" href="/assets/js/77.3e0ae479.js"><link rel="prefetch" href="/assets/js/78.c9eaa8ad.js"><link rel="prefetch" href="/assets/js/79.fdd89ab1.js"><link rel="prefetch" href="/assets/js/8.5fd4d70d.js"><link rel="prefetch" href="/assets/js/80.bad45019.js"><link rel="prefetch" href="/assets/js/81.38ca492e.js"><link rel="prefetch" href="/assets/js/82.04ea644d.js"><link rel="prefetch" href="/assets/js/83.03faa2ff.js"><link rel="prefetch" href="/assets/js/84.dbe7de1f.js"><link rel="prefetch" href="/assets/js/85.57b0744d.js"><link rel="prefetch" href="/assets/js/86.f727a2cb.js"><link rel="prefetch" href="/assets/js/9.a7ca0c84.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ffa631a0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">IPLD Specifications</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/schemas/" class="nav-link">
  IPLD Schemas
</a></div> <a href="https://github.com/ipld/specs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/schemas/" class="nav-link">
  IPLD Schemas
</a></div> <a href="https://github.com/ipld/specs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>DAG-PB Spec</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/block-layer/codecs/dag-pb.html#serial-format" class="sidebar-link">Serial Format</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/block-layer/codecs/dag-pb.html#logical-format" class="sidebar-link">Logical Format</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/block-layer/codecs/dag-pb.html#alternative-legacy-pathing" class="sidebar-link">Alternative (Legacy) Pathing</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/block-layer/codecs/dag-pb.html#canonical-dag-pb" class="sidebar-link">Canonical DAG-PB</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/block-layer/codecs/dag-pb.html#zero-length-blocks" class="sidebar-link">Zero-length blocks</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dag-pb-spec"><a href="#dag-pb-spec" class="header-anchor">#</a> DAG-PB Spec</h1> <p><strong>Status: Descriptive - Draft</strong></p> <p>DAG-PB does not support the full <a href="/data-model-layer/data-model.html">&quot;IPLD Data Model.&quot;</a></p> <h2 id="serial-format"><a href="#serial-format" class="header-anchor">#</a> Serial Format</h2> <p>The DAG-PB IPLD serial format is described with a single protobuf:</p> <div class="language-protobuf extra-class"><pre class="language-protobuf"><code><span class="token comment">// An IPFS MerkleDAG Link</span>
<span class="token keyword">message</span> <span class="token class-name">PBLink</span> <span class="token punctuation">{</span>

  <span class="token comment">// binary CID (with no multibase prefix) of the target object</span>
  <span class="token keyword">optional</span> <span class="token builtin">bytes</span> Hash <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// UTF-8 string name</span>
  <span class="token keyword">optional</span> <span class="token builtin">string</span> Name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token comment">// cumulative size of target object</span>
  <span class="token keyword">optional</span> <span class="token builtin">uint64</span> Tsize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// An IPFS MerkleDAG Node</span>
<span class="token keyword">message</span> <span class="token class-name">PBNode</span> <span class="token punctuation">{</span>

  <span class="token comment">// refs to other objects</span>
  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PBLink</span> Links <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token comment">// opaque user data</span>
  <span class="token keyword">optional</span> <span class="token builtin">bytes</span> Data <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The objects link names are specified in the 'Name' field of the PBLink object.
All link names in an object must either be omitted or unique within the object.</p> <p>DAG-PB aims to have a canonical form for any given set of data. Therefore, in addition to the standard Protobuf parsing rules, DAG-PB decoders should enforce additional constraints to ensure canonical forms (where possible):</p> <ol><li>Fields must appear in their correct order as defined by the Protobuf schema above, blocks with out-of-order fields should be rejected. It is common for Protobuf decoders to accept out-of-order field entries.</li> <li>Duplicate entries in the binary form are invalid, blocks with duplicate field values should be rejected. It is common for Protobuf decoders to accept <em>updates</em> to fields that have already been set.</li> <li>Fields and wire types other than those that appear in the Protobuf schema above are invalid and blocks containing these should be rejected. It is common for Protobuf decoders to skip data in each message type that does not match the fields in the schema.</li></ol> <h2 id="logical-format"><a href="#logical-format" class="header-anchor">#</a> Logical Format</h2> <p>When we handle DAG-PB content at the Data Model level, we treat these objects as maps.</p> <p>This layout can be expressed with <a href="/schemas/">IPLD Schemas</a> as:</p> <div class="language-ipldsch extra-class"><pre class="language-ipldsch"><code><span class="token typedef"><span class="token keyword">type</span> <span class="token class-name">PBNode</span></span> <span class="token builtin">struct</span> <span class="token punctuation">{</span>
  Links <span class="token punctuation">[</span>PBLink<span class="token punctuation">]</span>
  Data <span class="token keyword">optional</span> Bytes
<span class="token punctuation">}</span>

<span class="token typedef"><span class="token keyword">type</span> <span class="token class-name">PBLink</span></span> <span class="token builtin">struct</span> <span class="token punctuation">{</span>
  Hash Link
  Name <span class="token keyword">optional</span> String
  Tsize <span class="token keyword">optional</span> Int
<span class="token punctuation">}</span>
</code></pre></div><p>Constraints:</p> <ul><li>The first node in a block of DAG-PB data will match the <code>PBNode</code> type.</li> <li><code>Data</code> may be omitted or a byte array with a length of zero or more.</li> <li><code>Links</code>:
<ul><li>must be present, even if empty; the binary form makes no distinction between an empty array and an omitted value, in the Data Model we always instantiate an array.</li> <li>elements must be sorted in ascending order by their <code>Name</code> values, which are compared by bytes rather than as strings.</li></ul></li> <li><code>Hash</code>:
<ul><li>even though <code>Hash</code> is <code>optional</code> in the Protobuf encoding, it should not be treated as optional when creating new blocks or decoding existing ones, an omitted <code>Hash</code> should be interpreted as a bad block</li> <li>the bytes in the encoding format is interpreted as the bytes of a CID, if the bytes cannot be converted to a CID then it should be treated as a bad block.</li> <li>the data is encoded in the binary form as a byte array, it is therefore possible for a decoder to read a correct binary form but fail to convert a <code>Hash</code> to a CID and therefore treat it as a bad block.</li></ul></li> <li>When creating data, you can create maps using the standard Data Model concepts, and as long as they have exactly these fields. If additional fields are present, the DAG-PB codec will error, because there is no way to encode them.</li></ul> <p>The most recent <a href="https://github.com/ipld/js-dag-pb" target="_blank" rel="noopener noreferrer">JavaScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> implementation strictly exposes this logical format via the Data Model and does not support alternative means of resolving paths via named links as the legacy implementations do (see below). The most recent <a href="https://github.com/ipld/go-ipld-prime-proto" target="_blank" rel="noopener noreferrer">Go<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> implementation also avoids alternate pathing mechanisms but does not yet support the strict logical format.</p> <h2 id="alternative-legacy-pathing"><a href="#alternative-legacy-pathing" class="header-anchor">#</a> Alternative (Legacy) Pathing</h2> <p>While the <a href="#logical-format">logical format</a> implicitly describes a set of mechanisms for pathing over and through DAG-PB data in strict Data Model form, legacy implementations afford a means of resolving paths by privileging the <code>Name</code> in links.</p> <p>This alternative pathing is covered here as part of this descriptive spec, but was developed independently of the Data Model and is thus not well standardized.
The alternative pathing mechanisms differ between implementations and has been removed from the newer implementations entirely.</p> <p>The legacy <a href="https://github.com/ipfs/go-merkledag/tree/master/pb" target="_blank" rel="noopener noreferrer">Go<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="github.com/ipld/js-ipld-dag-pb">JavaScript</a> implementations both support pathing with link names: <code>/&lt;name1&gt;/&lt;name2&gt;/…</code>.</p> <p>In the legacy Go implementation, this is the only way, which implies that is is impossible to path through nodes that don't name their links. Also neither the Data section nor the Links section/metadata are accessible through paths.</p> <p>In the legacy JavaScript implementation, there is an additional way to path through the data. It's based purely on the structure of object, i.e. <code>/Links/&lt;index&gt;/Hash/…</code>. This way you have direct access to the <code>Data</code>, <code>Links</code>, and <code>size</code> fields, e.g. <code>/Links/&lt;index&gt;/Hash/Data</code>.</p> <p>These two ways of pathing can be combined, so you can access e.g. the <code>Data</code> field of a named link via <code>/&lt;name/Data</code>. You can also use both approaches within a single path, e.g. <code>/&lt;name1&gt;/Links/0/Hash/Data</code> or <code>/Links/&lt;index&gt;/Hash/&lt;name&gt;/Data</code>. When using the DAG API in js-ipfs, then the pathing over the structure has precedence, so you won't be able to use named pathing on a named link called <code>Links</code>, you would need to use the index of the link instead.</p> <h2 id="canonical-dag-pb"><a href="#canonical-dag-pb" class="header-anchor">#</a> Canonical DAG-PB</h2> <p>Canonical DAG-PB must:</p> <ol><li>Contain only the specified protobuf fields.</li> <li>Use standard protobuf encoding, with the following field orders:</li></ol> <ul><li>PBNode: Links, Data</li> <li>PBLink: Hash, Name, Tsize</li></ul> <p>Historical Note: The ordering (Links then Data) of the PBNode message is due to
a bug in the initial protobuf encoder that was used in the first implementation
of ipfs. Take care to maintain this ordering for full compatibility.</p> <h2 id="zero-length-blocks"><a href="#zero-length-blocks" class="header-anchor">#</a> Zero-length blocks</h2> <p>The zero-length DAG-PB block is valid and will be decoded as having null <code>Data</code> and null <code>Links</code>.</p> <p>With a SHA2-256 multihash, the CID of this block is:</p> <ul><li>CIDv1: bafybeihdwdcefgh4dqkjv67uzcmw7ojee6xedzdetojuzjevtenxquvyku</li> <li>CIDv0: QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ipld/specs/edit/master/block-layer/codecs/dag-pb.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/13/2020, 9:39:09 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.529fa14a.js" defer></script><script src="/assets/js/2.78e42933.js" defer></script><script src="/assets/js/18.210763d5.js" defer></script>
  </body>
</html>
